@inject AuthService AuthService
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="mb-3">
    <input class="form-control" @bind="_email" @bind:event="oninput" placeholder="Email" type="email" />
</div>
<div class="mb-3">
    <input class="form-control" @bind="_password" @bind:event="oninput" type="password" placeholder="Password" />
</div>
<div class="mb-3">
    <input class="form-control" @bind="_confirmPassword" @bind:event="oninput" type="password" placeholder="Confirm Password" />
</div>

<button class="btn btn-primary" @onclick="RegisterUser" disabled="@_isLoading">
    @if (_isLoading)
    {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    }
    Register
</button>

@if (!string.IsNullOrEmpty(_message))
{
    <p class="mt-3 @_messageClass">@_message</p>
}

@code {
    [Parameter]
    public EventCallback OnRegistrationSuccess { get; set; }

    private string _email = "";
    private string _password = "";
    private string _confirmPassword = "";
    private string _message = "";
    private string _messageClass = "text-danger";
    private bool _isLoading;

    private async Task RegisterUser()
    {
        try
        {
            _isLoading = true;
            _message = "";
            _messageClass = "text-danger";
            StateHasChanged();

            // --- Form Validation (This part is good, no changes needed) ---
            if (string.IsNullOrWhiteSpace(_email) || !IsValidEmail(_email))
            {
                _message = "Please enter a valid email address.";
                return;
            }
            if (string.IsNullOrWhiteSpace(_password) || _password.Length < 4)
            {
                _message = "Password must be at least 4 characters long.";
                return;
            }
            if (_password != _confirmPassword)
            {
                _message = "Passwords do not match.";
                return;
            }

            var tokenResponse = await AuthService.RegisterAndLoginUser(_email, _password);

            if (tokenResponse != null)
            {
                _message = "Registration successful! Logging you in...";
                _messageClass = "text-success";
                StateHasChanged();

                await Task.Delay(2000); // Good for user experience

                var authProvider = (CustomAuthStateProvider)AuthenticationStateProvider;
                await authProvider.NotifyUserAuthenticationAsync(tokenResponse.AccessToken);

                // Reset the form's state
                _email = "";
                _password = "";
                _confirmPassword = "";
                _message = "";
                
                // Signal to the parent component to close the pop-up.
                await OnRegistrationSuccess.InvokeAsync();
            }
            else
            {
                // The AuthService returns null if registration fails (e.g., email exists).
                _message = "Registration failed. This email may already be in use.";
                _messageClass = "text-danger";
            }
        }
        catch (Exception ex)
        {
            _message = "An unexpected error occurred during registration.";
            _messageClass = "text-danger";
            Console.WriteLine($"Registration error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
}