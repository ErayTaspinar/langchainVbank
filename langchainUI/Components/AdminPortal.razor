@using Dapper
@using Npgsql
@inject IConfiguration Configuration

<style>
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @@keyframes slideIn {
        from { transform: translateX(-100%); }
        to { transform: translateX(0); }
    }

    .admin-card {
        animation: fadeIn 0.5s ease-out;
        transition: all 0.3s ease;
        border: none;
        border-radius: 12px;
        overflow: hidden;
    }

    .admin-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    }

    #admin-sidebar-wrapper {
        width: 260px;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        animation: slideIn 0.4s ease-out;
    }

    .sidebar-heading {
        padding: 1.5rem;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
    }

    .list-group-item {
        border: none !important;
        transition: all 0.3s ease;
        padding: 1rem 1.5rem;
        margin: 0.25rem 0.5rem;
        border-radius: 8px;
    }

    .list-group-item:hover {
        background: rgba(102, 126, 234, 0.2) !important;
        transform: translateX(5px);
        padding-left: 2rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #6c757d;
    }

    .btn-modern {
        border-radius: 8px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }

    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .dashboard-header {
        animation: fadeIn 0.6s ease-out;
        margin-bottom: 2rem;
    }

    .spinner-modern {
        width: 3rem;
        height: 3rem;
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .card-primary { border-left: 4px solid #667eea !important; }
    .card-success { border-left: 4px solid #28a745 !important; }
    .card-info { border-left: 4px solid #17a2b8 !important; }
    .card-warning { border-left: 4px solid #ffc107 !important; }

    .alert-modern {
        border-radius: 12px;
        border: none;
        animation: fadeIn 0.5s ease-out;
    }
</style>

<div class="d-flex" id="admin-wrapper" style="height: 100vh;">
    <div class="border-right" id="admin-sidebar-wrapper">
        <div class="sidebar-heading text-white">
            <i class="fas fa-shield-alt me-2"></i>Admin Panel
        </div>
        <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action bg-transparent text-white">
                <i class="fas fa-tachometer-alt fa-fw me-3"></i>Dashboard
            </a>
            <a href="#" class="list-group-item list-group-item-action bg-transparent text-white">
                <i class="fas fa-users fa-fw me-3"></i>Manage Users
            </a>
            <a href="#" class="list-group-item list-group-item-action bg-transparent text-white">
                <i class="fas fa-cog fa-fw me-3"></i>Settings
            </a>
            <hr class="bg-light mx-3"/>
            <a href="#" @onclick="ExitAdminView" @onclick:preventDefault class="list-group-item list-group-item-action bg-transparent text-white">
                <i class="fas fa-arrow-left fa-fw me-3"></i>Back to Main Site
            </a>
        </div>
    </div>

    <div id="admin-page-content-wrapper" class="flex-grow-1" style="overflow-y: auto; background: #f8f9fc;">
        <main class="container-fluid p-4">
            <div class="container-fluid">
                <div class="dashboard-header d-sm-flex align-items-center justify-content-between mb-4">
                    <div>
                        <h1 class="h2 mb-1" style="font-weight: 700; color: #2c3e50;">Dashboard Overview</h1>
                    </div>
                    <button class="btn btn-modern text-white shadow-sm mt-3 mt-sm-0">
                        <i class="fas fa-download fa-sm me-2"></i>Generate Report
                    </button>
                </div>

                @if (isLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-modern mx-auto"></div>
                        <p class="mt-3 text-muted">Loading dashboard data...</p>
                    </div>
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger alert-modern shadow-sm" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>@errorMessage
                    </div>
                }
                else
                {
                    <div class="row">
                        <div class="col-xl-3 col-md-6 mb-4" style="animation-delay: 0.1s;">
                            <div class="card admin-card card-primary shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label mb-2">Registered Users</div>
                                            <div class="stat-number">@userCount.ToString("N0")</div>
                                        </div>
                                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                            <i class="fas fa-users fa-2x text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4" style="animation-delay: 0.2s;">
                            <div class="card admin-card card-success shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label mb-2">Total Chats</div>
                                            <div class="stat-number" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">@chatCount.ToString("N0")</div>
                                        </div>
                                        <div class="stat-icon" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                            <i class="fas fa-comments fa-2x text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4" style="animation-delay: 0.3s;">
                            <div class="card admin-card card-info shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label mb-2">Total Images</div>
                                            <div class="stat-number" style="background: linear-gradient(135deg, #17a2b8 0%, #00d4ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">@imageCount.ToString("N0")</div>
                                        </div>
                                        <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #00d4ff 100%);">
                                            <i class="fas fa-images fa-2x text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4" style="animation-delay: 0.4s;">
                            <div class="card admin-card card-warning shadow-sm h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label mb-2">Active Sessions</div>
                                            <div class="stat-number" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">@uniqueIdCount.ToString("N0")</div>
                                        </div>
                                        <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                                            <i class="fas fa-key fa-2x text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </main>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback OnExit { get; set; }

    private int userCount, chatCount, imageCount, uniqueIdCount;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync() => await LoadDashboardData();

    private async Task LoadDashboardData()
    {
        isLoading = true;
        try
        {
            var constr = Configuration.GetConnectionString("DefaultConnection");
            await using var connection = new NpgsqlConnection(constr);
            await connection.OpenAsync();
            userCount = await connection.ExecuteScalarAsync<int>("SELECT COUNT(*) FROM users");
            chatCount = await connection.ExecuteScalarAsync<int>("SELECT COUNT(*) FROM chats");
            imageCount = await connection.ExecuteScalarAsync<int>("SELECT COUNT(*) FROM images");
            uniqueIdCount = await connection.ExecuteScalarAsync<int>("SELECT COUNT(*) FROM unique_ids");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ExitAdminView()
    {
        await OnExit.InvokeAsync();
    }
}