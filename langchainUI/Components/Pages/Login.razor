@inject DatabaseService DbService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<h3>Login</h3>

<div class="mb-3">
    <input class="form-control" @bind="Email" @bind:event="oninput" placeholder="Email" type="email" />
</div>
<div class="mb-3">
    <input class="form-control" @bind="Password" @bind:event="oninput" type="password" placeholder="Password" />
</div>

<button class="btn btn-primary" @onclick="LoginUser" disabled="@isLoading">
    @if (isLoading)
    {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    }
    Login
</button>

@if (!string.IsNullOrEmpty(Message))
{
    <p class="mt-3 text-danger">@Message</p>
}

@code {
    [Parameter]
    public EventCallback OnLoginSuccess { get; set; }

    private string Email = "";
    private string Password = "";
    private string Message = "";
    private bool isLoading = false;

    private async Task LoginUser()
    {
        try
        {
            isLoading = true;
            Message = "";
            StateHasChanged();

            if (string.IsNullOrWhiteSpace(Email))
            {
                Message = "Email is required.";
                return;
            }

            if (string.IsNullOrWhiteSpace(Password))
            {
                Message = "Password is required.";
                return;
            }

            var userExists = await DbService.UserExists(Email);
            if (!userExists)
            {
                Message = "User not found. Please check your email address.";
                return;
            }

            var accessToken = await DbService.ValidateUserAndGetToken(Email, Password);

            if (accessToken != null)
            {
                var authProvider = (CustomAuthStateProvider)AuthenticationStateProvider;
                await authProvider.NotifyUserAuthenticationAsync(accessToken);

                Email = "";
                Password = "";

                await OnLoginSuccess.InvokeAsync();
            }
            else
            {
                Message = "Invalid password. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Message = "An error occurred during login. Please try again.";
            await JsRuntime.InvokeVoidAsync("console.error", "Login error:", ex.Message);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}