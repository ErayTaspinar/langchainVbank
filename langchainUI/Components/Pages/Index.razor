@page "/"
@rendermode InteractiveServer
@layout EmptyLayout
@implements IDisposable

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<div class="page-container">
    @if (_isAuthenticated)
    {
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3 class="logo-text">ChatBot</h3>
            </div>
            <div class="sidebar-actions">
                <button class="btn-new-chat" @onclick="StartNewConversation">
                    + New Chat
                </button>
            </div>
            <div class="conversation-list">
                @foreach (var conversation in _conversations)
                {
                    <div class="conversation-item @(conversation.Id == _activeConversation?.Id ? "active" : "")" @onclick="() => SelectConversation(conversation)">
                        @conversation.Title
                    </div>
                }
            </div>
        </aside>
    }

    <!-- 2. Main Chat Area -->
    <div class="chat-container">
        <header class="top-header">
            <!-- Logo has been removed from here -->
            <div class="header-content">
                <div class="auth-section">
                    @if (!_isAuthenticated)
                    {
                        <button class="btn-ghost" @onclick='() => OpenModal("login")'>
                            Log in
                        </button>
                        <button class="btn-primary" @onclick='() => OpenModal("register")'>
                            Sign up
                        </button>
                    }
                    else
                    {
                        <button class="btn-ghost">Log out</button>
                    }
                </div>
            </div>
        </header>

        <main class="chat-main-content">
            @if (_activeConversation != null)
            {
                @if (!_isAuthenticated && _activeConversation.Messages.Count == 0)
                {
                    <div class="welcome-content">
                        <div class="welcome-header">
                            <h1 class="welcome-title">ChatBot</h1>
                            <p class="subtitle">How can I help you today?</p>
                        </div>
                    </div>
                }
                else
                {
                    <div class="messages-display">
                        @foreach (var message in _activeConversation.Messages)
                        {
                            <div class="message @(message.IsUser ? "user-message" : "bot-message")">
                                <p>@message.Text</p>
                            </div>
                        }
                    </div>
                }
            }
        </main>
        
        <footer class="chat-input-area">
            <div class="input-container">
                <input @bind="_newMessage" @bind:event="oninput" @onkeyup="HandleKeyUp" class="form-control" placeholder="Type your message..." />
                <button class="btn-primary" @onclick="HandleSendAttempt">Send</button>
            </div>
        </footer>
    </div>
</div>


@if (_showModal)
{
    <ModalDialog Title="@_modalTitle" OnClose="CloseModal">
        @if (_modalContent == "login")
        {
            <Login OnLoginSuccess="HandleLoginSuccess" />
        }
        else if (_modalContent == "register")
        {
            <Register />
        }
    </ModalDialog>
}


<style>
    /* Global Resets */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Full Page Layout */
    .page-container {
        display: flex;
        height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        overflow: hidden;
    }

    .sidebar {
        width: 260px;
        flex-shrink: 0;
        background-color: #f3f4f6;
        border-right: 1px solid #e5e5e5;
        display: flex;
        flex-direction: column;
    }
    
    .sidebar-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e5e5;
    }
    
    /* Style for the container of the "New Chat" button */
    .sidebar-actions {
        padding: 1rem;
        border-bottom: 1px solid #e5e5e5;
    }

    .btn-new-chat {
        width: 100%;
        padding: 0.75rem;
        background-color: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        text-align: left;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn-new-chat:hover {
        background-color: #e5e7eb;
    }

    .conversation-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .conversation-item {
        padding: 0.75rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.875rem;
    }

    .conversation-item:hover {
        background-color: #e5e7eb;
    }

    .conversation-item.active {
        background-color: #0066cc;
        color: white;
    }

    /* Chat Container Styles */
    .chat-container { 
        display: flex; 
        flex-direction: column; 
        flex-grow: 1;
        background-color: #ffffff;
    }
    
    .top-header { 
        flex-shrink: 0;
        background-color: white; 
        border-bottom: 1px solid #e5e5e5; 
    }

    .header-content { 
        display: flex; 
        justify-content: flex-end; 
        align-items: center; 
        padding: 0.75rem 1rem; 
        max-width: 1200px; 
        margin: 0 auto; 
    }

    .logo-text { font-size: 1.25rem; font-weight: 600; color: #0066cc; }
    .auth-section { display: flex; gap: 0.5rem; align-items: center; }

    .btn-ghost { background: none; border: none; color: #374151; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
    .btn-ghost:hover { background-color: #f3f4f6; }
    .btn-primary { background-color: #0066cc; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
    .btn-primary:hover { background-color: #0052a3; }
    
    .chat-main-content { 
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem; 
        display: flex; 
        flex-direction: column; 
    } 

    .welcome-content { text-align: center; margin: auto; }
    .welcome-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: #0066cc; }
    .messages-display { display: flex; flex-direction: column; gap: 0.75rem; max-width: 800px; width: 100%; margin: 0 auto; justify-content: flex-end; flex-grow: 1; }
    
    .message { padding: 0.75rem 1rem; border-radius: 12px; max-width: 80%; word-wrap: break-word; }
    .user-message { background-color: #f0f0f0; align-self: flex-end; border-bottom-right-radius: 0; }
    .bot-message { background-color: #e1f0ff; align-self: flex-start; border-bottom-left-radius: 0; }
    
    .chat-input-area { 
        flex-shrink: 0;
        padding: 1rem; 
        border-top: 1px solid #e5e5e5; 
        background-color: #ffffff; 
    }

    .input-container { display: flex; gap: 0.5rem; max-width: 800px; margin: 0 auto; align-items: center; }
    .form-control { flex: 1; padding: 0.75rem; border-radius: 20px; border: 1px solid #e5e5e5; }
</style>

@code {
    private bool _isAuthenticated;
    private string _newMessage = string.Empty;
    private bool _showModal = false;
    private string _modalTitle = "";
    private string _modalContent = "";
    private bool _disposed = false;

    private List<Conversation> _conversations = new List<Conversation>();
    private Conversation? _activeConversation;

    protected override async Task OnInitializedAsync()
    {
        AuthenticationStateProvider.AuthenticationStateChanged += HandleAuthenticationStateChanged;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

        // A conversation is always needed, whether logged in or out
        if (_conversations.Count == 0)
        {
            StartNewConversation();
        }
    }

    private void StartNewConversation()
    {
        var newConversation = new Conversation();
        _conversations.Insert(0, newConversation);
        _activeConversation = newConversation;
    }

    private void SelectConversation(Conversation conversation)
    {
        _activeConversation = conversation;
    }

    private async Task SendMessage()
    {
        if (_activeConversation == null) return;

        var userMessage = new ChatMessage { Text = _newMessage, IsUser = true };

        if (_activeConversation.Messages.Count == 0)
        {
            _activeConversation.Title = _newMessage.Length > 25 ? _newMessage.Substring(0, 25) + "..." : _newMessage;
        }
        
        _activeConversation.Messages.Add(userMessage);
        
        var messageToSend = _newMessage;
        _newMessage = string.Empty;
        await InvokeAsync(StateHasChanged);

        await Task.Delay(500);
        var botMessage = new ChatMessage { Text = $"Simulated response to: '{messageToSend}'", IsUser = false };
        _activeConversation.Messages.Add(botMessage);
        
        await InvokeAsync(StateHasChanged);
    }

    private async void HandleAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        try
        {
            var authState = await task;
            var newIsAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
            await InvokeAsync(() =>
            {
                if (_disposed) return;
                
                // If the user's auth state has changed, update the UI
                if (newIsAuthenticated != _isAuthenticated)
                {
                    _isAuthenticated = newIsAuthenticated;

                    // When a user logs in, ensure they have a fresh chat list
                    if (_isAuthenticated)
                    {
                        _conversations.Clear();
                        StartNewConversation();
                    }
                    StateHasChanged();
                }
            });
        }
        catch (ObjectDisposedException) { }
    }

    private async Task HandleSendAttempt()
    {
        if (string.IsNullOrWhiteSpace(_newMessage)) return;
        if (_isAuthenticated) await SendMessage();
        else OpenModal("login");
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await HandleSendAttempt();
    }
    
    private async Task HandleLoginSuccess()
    {
        CloseModal();
        if (!string.IsNullOrWhiteSpace(_newMessage)) await SendMessage();
    }
    
    private void OpenModal(string content)
    {
        _modalContent = content;
        _modalTitle = content == "login" ? "Please log in to continue" : "Create an account to chat";
        _showModal = true;
    }
    
    private void CloseModal() => _showModal = false;

    public void Dispose()
    {
        _disposed = true;
        AuthenticationStateProvider.AuthenticationStateChanged -= HandleAuthenticationStateChanged;
    }

    public class ChatMessage
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
    }

    public class Conversation
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string Title { get; set; } = "New Chat";
        public List<ChatMessage> Messages { get; set; } = new List<ChatMessage>();
    }
}