@inject DatabaseService DbService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<h3>Register</h3>

<div class="mb-3">
    <input class="form-control" @bind="Email" @bind:event="oninput" placeholder="Email" type="email" />
</div>
<div class="mb-3">
    <input class="form-control" @bind="Password" @bind:event="oninput" type="password" placeholder="Password" />
</div>
<div class="mb-3">
    <input class="form-control" @bind="ConfirmPassword" @bind:event="oninput" type="password" placeholder="Confirm Password" />
</div>

<button class="btn btn-primary" @onclick="RegisterUser" disabled="@isLoading">
    @if (isLoading)
    {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    }
    Register
</button>

@if (!string.IsNullOrEmpty(Message))
{
    <p class="mt-3 @MessageClass">@Message</p>
}

@code {
    [Parameter]
    public EventCallback OnRegistrationSuccess { get; set; }

    private string Email = "";
    private string Password = "";
    private string ConfirmPassword = "";
    private string Message = "";
    private string MessageClass = "text-danger";
    private bool isLoading = false;

    private async Task RegisterUser()
    {
        try
        {
            isLoading = true;
            Message = "";
            MessageClass = "text-danger";
            StateHasChanged();

            // Validation
            if (string.IsNullOrWhiteSpace(Email))
            {
                Message = "Email is required.";
                return;
            }

            if (!IsValidEmail(Email))
            {
                Message = "Please enter a valid email address.";
                return;
            }

            if (string.IsNullOrWhiteSpace(Password))
            {
                Message = "Password is required.";
                return;
            }

            if (Password.Length < 4) 
            {
                Message = "Password must be at least 8 characters long.";
                return;
            }

            if (string.IsNullOrWhiteSpace(ConfirmPassword))
            {
                Message = "Please confirm your password.";
                return;
            }

            if (Password != ConfirmPassword)
            {
                Message = "Passwords do not match.";
                return;
            }

            var success = await DbService.RegisterUser(Email, Password);

            if (success)
            {
                Message = "Registration successful! Logging you in...";
                MessageClass = "text-success";
                StateHasChanged();

                var accessToken = await DbService.ValidateUserAndGetToken(Email, Password);

                if (!string.IsNullOrEmpty(accessToken))
                {
                    // Authenticate user
                    var authProvider = (CustomAuthStateProvider)AuthenticationStateProvider;

                    // FIX: Called NotifyUserAuthenticationAsync with only the access token, matching the provider's method signature
                    await authProvider.NotifyUserAuthenticationAsync(accessToken);

                    Email = "";
                    Password = "";
                    ConfirmPassword = "";
                    
                    await OnRegistrationSuccess.InvokeAsync();
                }
                else
                {
                    Message = "Registration succeeded, but auto-login failed. Please try logging in manually.";
                    MessageClass = "text-warning";
                }
            }
            else
            {
                Message = "Registration failed! This email may already be in use.";
                MessageClass = "text-danger";
            }
        }
        catch (Exception ex)
        {
            Message = $"An unexpected error occurred during registration. Please try again.";
            MessageClass = "text-danger";
            // For debugging, you can log the full exception
            Console.WriteLine($"Registration error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
}