# 1. DATABASE (Postgres) - WITH PERSISTENCE

# 1. Create the "Hard Drive" (Volume Claim)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
# Frontend DataProtection Keys (prevents antiforgery decryption errors after restarts)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: frontend-dpkeys-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 128Mi
---
# 1b. Initialize DB Schema (runs only on first init of the data directory)
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-sql
data:
  chatBotTesting.sql: |
    -- Users table
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        role VARCHAR(50) DEFAULT 'user',
        email_verified BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT NOW()
    );

    -- User salts table (NEW)
    CREATE TABLE IF NOT EXISTS user_salts (
        id SERIAL PRIMARY KEY,
        user_id INT NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
        salt TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT NOW()
    );

    -- Unique IDs table
    CREATE TABLE IF NOT EXISTS unique_ids (
        unique_id VARCHAR(255) PRIMARY KEY,
        user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE
    );

    -- Images table
    CREATE TABLE IF NOT EXISTS images (
        id SERIAL PRIMARY KEY,
        unique_id VARCHAR(255) NOT NULL REFERENCES unique_ids(unique_id) ON DELETE CASCADE,
        image_url TEXT,
        created_at TIMESTAMP DEFAULT NOW()
    );

    -- Chats table
    CREATE TABLE IF NOT EXISTS chats (
        id SERIAL PRIMARY KEY,
        unique_id VARCHAR(255) NOT NULL REFERENCES unique_ids(unique_id) ON DELETE CASCADE,
        chat_text TEXT NOT NULL,
        message_type VARCHAR(50) NOT NULL DEFAULT 'human',
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Chat images table
    CREATE TABLE IF NOT EXISTS chat_images (
        chat_id INT NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
        image_id INT REFERENCES images(id) ON DELETE CASCADE,
        image_token TEXT,
        start_pos INT NOT NULL,
        end_pos INT NOT NULL,
        PRIMARY KEY (chat_id, start_pos)
    );

    -- Refresh tokens table
    CREATE TABLE IF NOT EXISTS refresh_tokens (
        id SERIAL PRIMARY KEY,
        user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        token_hash VARCHAR(255) NOT NULL,
        expires_at TIMESTAMP NOT NULL,
        created_at TIMESTAMP DEFAULT NOW(),
        is_revoked BOOLEAN NOT NULL DEFAULT FALSE
    );

    -- Create indexes for better performance
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_user_salts_user_id ON user_salts(user_id);
    CREATE INDEX IF NOT EXISTS idx_unique_ids_user_id ON unique_ids(user_id);
    CREATE INDEX IF NOT EXISTS idx_images_unique_id ON images(unique_id);
    CREATE INDEX IF NOT EXISTS idx_chats_unique_id ON chats(unique_id);
    CREATE INDEX IF NOT EXISTS idx_chat_images_chat_id ON chat_images(chat_id);
    CREATE INDEX IF NOT EXISTS idx_chat_images_image_id ON chat_images(image_id);
    CREATE INDEX IF NOT EXISTS idx_refresh_tokens_token_hash ON refresh_tokens(token_hash);
    CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id ON refresh_tokens(user_id);
---
# 2. Service
apiVersion: v1
kind: Service
metadata:
  name: chatbottesting   # Lowercase (DNS requirement)
spec:
  ports:
    - port: 5432
  selector:
    app: postgres
---
# 3. Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15
          
          # MOUNT THE VOLUME (The "Hard Drive")
          volumeMounts:
            - mountPath: /var/lib/postgresql/data
              name: postgres-storage
            - name: postgres-init-sql
              mountPath: /docker-entrypoint-initdb.d/chatBotTesting.sql
              subPath: chatBotTesting.sql
              readOnly: true
              
          env:
            - name: POSTGRES_USER
              value: "eraytaspinar"
            - name: POSTGRES_DB
              value: "postgres"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: backend-secrets
                  key: DB_PASSWORD
          ports:
            - containerPort: 5432
            
      # DEFINE THE VOLUME
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: postgres-pvc
        - name: postgres-init-sql
          configMap:
            name: postgres-init-sql

---

# 2. PYTHON BACKEND (LangChain)
apiVersion: v1
kind: Service
metadata:
  name: langchain-service
spec:
  ports:
    - port: 5001
      targetPort: 5001
  selector:
    app: langchain
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: langchain
spec:
  replicas: 2
  selector:
    matchLabels:
      app: langchain
  template:
    metadata:
      labels:
        app: langchain
    spec:
      initContainers:
        - name: wait-for-db
          image: busybox
          command: ['sh', '-c', 'until nc -z chatbottesting 5432; do echo waiting for db; sleep 2; done;']
      containers:
        - name: langchain
          image: langchain:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5001
          
          # Load Secrets (DB Password + API Keys)
          envFrom:
            - secretRef:
                name: backend-secrets
          
          env:
            - name: DB_HOST
              value: "chatbottesting"
            - name: DB_PORT
              value: "5432"
            - name: DB_USER
              value: "eraytaspinar"
            - name: DB_NAME
              value: "postgres"
              
            # AI Cache Paths
            - name: SENTENCE_TRANSFORMERS_HOME
              value: "/app/model_cache"
            - name: TORCH_HOME
              value: "/app/model_cache"
            - name: HF_HOME
              value: "/app/model_cache"
          readinessProbe:
            httpGet:
              path: /healthz
              port: 5001
            initialDelaySeconds: 15
            periodSeconds: 10
            failureThreshold: 30

---

# 3. FRONTEND (Blazor)
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  type: LoadBalancer
  ports:
    - port: 5162
      targetPort: 8080
  selector:
    app: frontend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      initContainers:
        - name: wait-for-python
          image: busybox
          command: ['sh', '-c', 'until nc -z langchain-service 5001; do echo waiting for python; sleep 2; done;']
      containers:
        - name: frontend
          image: langchain-ui:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080

          volumeMounts:
            - name: frontend-dpkeys
              mountPath: /root/.aspnet/DataProtection-Keys
          
          # Load Secrets (DB Password + Security Key)
          envFrom:
            - secretRef:
                name: backend-secrets
            - secretRef:
                name: frontend-secrets
          
          # Explicit DB Config to prevent startup crash
          env:
            - name: API_BASE_URL
              value: "http://langchain-service:5001"
            - name: DB_HOST
              value: "chatbottesting"
            - name: DB_PORT
              value: "5432"
            - name: DB_USER
              value: "eraytaspinar"
            - name: DB_NAME
              value: "postgres"

      volumes:
        - name: frontend-dpkeys
          persistentVolumeClaim:
            claimName: frontend-dpkeys-pvc